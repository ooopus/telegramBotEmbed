# Telembed

Telembed 是一个功能强大的 Telegram 机器人，旨在根据预设的知识库在群聊中回答问题。它利用 Google Gemini 强大的词向量模型进行语义搜索，即使用户的提问没有包含精确的关键词，也能准确地找出最相关的答案。

无论是对于提问的用户，还是管理知识库的管理员，该机器人都提供了无缝的体验。所有的问答管理都通过一个交互式的 Telegram 界面直接完成。

## 功能特性

  * **语义问答**：超越简单的关键词匹配，能够理解用户问题的 *真实意图*，并从知识库中找到最佳答案。
  * **交互式问答管理**：管理员可以直接在 Telegram 中使用直观的命令和内联键盘，轻松地添加、列出、搜索、编辑和删除问答（Q\&A）对。
  * **强大的 API 密钥管理**：能够智能管理多个 Gemini API 密钥，支持轮询使用、速率限制（RPM/RPD），并在某个密钥超出配额时自动暂时禁用该密钥。
  * **持久化存储**：整个问答知识库存储在一个简单的 `JSON` 文件中。
  * **高效的词向量缓存**：自动缓存问题的词向量，以最大限度地减少对 Gemini API 的调用，从而降低成本并加快响应速度。
  * **灵活配置与安全**：
      * 可限制机器人仅在指定的群组中运行。
      * 可定义拥有全局权限的“超级管理员”。
      * 依赖群组管理员权限进行管理操作。
  * **简洁的聊天界面**：在可配置的延迟后，自动删除用户的命令和机器人的回复，以保持群聊的整洁。

## 工作原理

该机器人的核心智能基于“词向量”（Embeddings）技术，这是一种将文本转换为数字表示形式的方法。

1.  **初始化**：启动时，机器人会从 `QA.json` 文件加载所有的问答对。
2.  **生成词向量**：对于知识库中的每一个问题，它会调用 Gemini API 来生成一个向量表示（即词向量）。这些词向量会被保存在磁盘上的缓存文件中，以避免在后续重启时重复调用 API。
3.  **用户提问**：当用户在已配置的群组中发送消息时，机器人会将其视为一个潜在的问题。
4.  **语义搜索**：机器人为用户的提问实时生成词向量，并使用 **余弦相似度** 算法，将其与知识库中所有问题的词向量进行比较。
5.  **匹配与响应**：如果计算出的最高相似度分数超过了配置的阈值（例如 `0.85`），则意味着找到了一个可信的匹配项。机器人将回复匹配问题的对应答案。如果没有匹配项达到该阈值，机器人将保持沉默，以避免发送不相关的答案。
6.  **知识库管理**：当管理员添加、编辑或删除一个问答对时，机器人会更新 `QA.json` 文件，并自动重新加载和生成内存中的词向量，以立即反映这些更改。

## 安装与配置

1.  **先决条件**：你需要安装 [Rust 工具链](https://www.rust-lang.org/tools/install)。

2.  **克隆仓库**：

    ```bash
    git clone https://github.com/ooopus/telembed.git
    cd telembed
    ```

3.  **配置**：
    首次运行机器人时，它会在你的系统配置目录（例如 Linux 上的 `~/.config/telembed/config.toml`）下自动创建一个 `config.toml` 文件。你需要编辑此文件并填入你的信息。

    ```toml
    # 配置文件示例 (src/config/types.rs)
    [telegram]
    token = "YOUR_TELEGRAM_BOT_TOKEN" # 从 BotFather 获取
    super_admins = [123456789]        # 你的 Telegram 数字 ID
    allowed_group_ids = [-1001234567890] # 机器人需要运行的群组ID

    [embedding]
    api_keys = ["YOUR_GEMINI_API_KEY_1", "YOUR_GEMINI_API_KEY_2"] # 从 Google AI Studio 获取
    model = "gemini-embedding-exp-03-07"
    ndims = 3072
    rpm = 5  # 每个密钥的每分钟请求数限制 (Requests-Per-Minute)
    rpd = 100 # 每个密钥的每天请求数限制 (Requests-Per-Day)

    [similarity]
    threshold = 0.85 # 匹配的置信度阈值 (0.0 到 1.0)

    [message]
    delete_delay = 10 # 机器人回复后多少秒删除该回复
    timeout = 60      # 忽略超过 60 秒的旧消息

    [qa]
    qa_json_path = "data/QA.json" # 你的知识库文件路径
    ```

4.  **创建知识库文件**：
    创建 `data` 目录和一个空的 `QA.json` 文件。

    ```bash
    mkdir data
    echo "[]" > data/QA.json
    ```

5.  **运行机器人**：

    ```bash
    cargo run --release
    ```

## 使用方法 (机器人命令)

所有管理命令都需要用户是群组的管理员。

  * `/addqa`
    通过回复一条消息来使用此命令，被回复的消息将成为 **问题**。机器人会提示你回复相应 **答案**。最后，它会请求确认，然后保存新的问答对。

  * `/answer`
    通过回复一条消息来使用此命令，强制机器人将该消息视为问题并寻找答案。

  * `/listqa`
    在一个交互式面板中列出所有的问答对。你可以点击任何一个问题进行查看、编辑或删除。

  * `/searchqa <关键词>`
    根据给定的关键词在知识库中搜索问题，并在一个交互式管理面板中显示搜索结果。

  * `/start`
    显示一条简单的欢迎消息。
